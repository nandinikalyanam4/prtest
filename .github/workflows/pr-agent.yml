name: PR Agent - Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  pr-review:
    name: PR Agent Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      statuses: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "‚ö†Ô∏è Some dependencies failed to install, continuing..."
        continue-on-error: true
      
      - name: Set environment variables
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "${{ github.event.pull_request.number }}" ]; then
            echo "‚ö†Ô∏è Not a pull request event, skipping PR Agent"
            exit 0
          fi
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
          echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
      
      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version
      
      - name: Secret Scanning (Gitleaks)
        id: gitleaks
        run: |
          echo "üîí Running Gitleaks secret scanning..."
          gitleaks detect --source . --verbose --report-format json --report-path gitleaks-report.json --exit-code 0 || true
          
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
            echo "‚ùå Secrets detected by Gitleaks"
            # Post comment on PR
            python3 -c "
            import os
            import json
            import sys
            sys.path.insert(0, '.')
            from scripts.utils.github_api import GitHubAPI
            
            try:
                github_token = os.getenv('GITHUB_TOKEN')
                github_repo = os.getenv('GITHUB_REPOSITORY')
                pr_number = int(os.getenv('PR_NUMBER'))
                
                with open('gitleaks-report.json', 'r') as f:
                    data = json.load(f)
                
                # Handle different Gitleaks output formats
                if isinstance(data, list):
                    report = data
                elif isinstance(data, dict) and 'findings' in data:
                    report = data['findings']
                else:
                    report = []
                
                github_api = GitHubAPI(github_token, github_repo)
                
                comment = '‚ùå **üö´ PR BLOCKED: Secrets Detected by Gitleaks**\n\n'
                comment += f'**Found {len(report)} potential secrets. This PR cannot be merged until all secrets are removed.**\n\n'
                
                for finding in report[:10]:
                    file_path = finding.get('File', finding.get('file', 'unknown'))
                    line = finding.get('Line', finding.get('line', '?'))
                    rule = finding.get('RuleID', finding.get('rule', 'unknown'))
                    comment += f'- **{file_path}:{line}** - {rule}\n'
                
                if len(report) > 10:
                    comment += f'\n... and {len(report) - 10} more findings\n'
                
                comment += '\n**üö´ BLOCKING ISSUE:** This PR is blocked from merging. Remove all secrets before proceeding.'
                
                github_api.post_comment(pr_number, comment)
            except Exception as e:
                print(f'Error posting Gitleaks comment: {e}')
            "
            echo "‚ùå PR BLOCKED: Secrets detected. This PR cannot be merged."
            exit 1
          else
            echo "‚úÖ No secrets detected by Gitleaks"
          fi
      
      - name: Custom Secret Scanning
        id: secrets_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üîí Running custom secret scanning..."
          echo "PYTHONPATH=$PYTHONPATH"
          echo "Current directory: $(pwd)"
          echo "Files in scripts/: $(ls -la scripts/ | head -5)"
          if ! python scripts/secrets_check.py; then
            echo "‚ùå üö´ PR BLOCKED: Custom secret scanning failed. This PR cannot be merged."
            exit 1
          else
            echo "‚úÖ Custom secret scanning passed"
          fi
      
      - name: Static Code Analysis
        id: static_analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üìä Running static code analysis..."
          if ! python scripts/static_analysis.py; then
            echo "‚ùå üö´ PR BLOCKED: Static analysis found blocking issues. This PR cannot be merged."
            exit 1
          else
            echo "‚úÖ Static analysis passed"
          fi
      
      - name: Jira Validation
        id: jira_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üé´ Validating Jira ticket..."
          if ! python scripts/jira_check.py; then
            echo "‚ùå üö´ PR BLOCKED: Jira validation failed. This PR cannot be merged."
            exit 1
          else
            echo "‚úÖ Jira validation passed"
          fi
      
      - name: AI Code Review
        id: ai_review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL || 'gpt-4o' }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "ü§ñ Running AI code review..."
          python scripts/ai_review.py || AI_EXIT_CODE=$?
          if [ "${AI_EXIT_CODE:-0}" -ne 0 ]; then
            echo "‚ùå AI review failed"
            exit 1
          else
            echo "‚úÖ AI review passed"
          fi
        continue-on-error: true
      
      - name: Post Summary Comment
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "üìä Posting summary comment..."
          echo "PYTHONPATH=$PYTHONPATH"
          python3 -c "
          import os
          import sys
          sys.path.insert(0, os.getcwd())
          
          try:
              from scripts.utils.github_api import GitHubAPI
              
              github_token = os.getenv('GITHUB_TOKEN')
              github_repo = os.getenv('GITHUB_REPOSITORY')
              pr_number = os.getenv('PR_NUMBER')
              
              if not all([github_token, github_repo, pr_number]):
                  print('‚ö†Ô∏è Missing environment variables for summary comment')
                  sys.exit(0)
              
              github_api = GitHubAPI(github_token, github_repo)
              
              # Get step results - GitHub Actions will substitute these before Python runs
              gitleaks_outcome = '${{ steps.gitleaks.outcome }}'
              secrets_outcome = '${{ steps.secrets_check.outcome }}'
              static_outcome = '${{ steps.static_analysis.outcome }}'
              jira_outcome = '${{ steps.jira_check.outcome }}'
              ai_outcome = '${{ steps.ai_review.outcome }}'
              
              # Determine status emojis and text
              gitleaks_status = '‚úÖ' if gitleaks_outcome == 'success' else '‚ùå'
              secrets_status = '‚úÖ' if secrets_outcome == 'success' else '‚ùå'
              static_status = '‚úÖ' if static_outcome == 'success' else '‚ùå'
              jira_status = '‚úÖ' if jira_outcome == 'success' else '‚ùå'
              ai_status = '‚úÖ' if ai_outcome == 'success' else '‚ùå'
              
              gitleaks_text = 'PASS' if gitleaks_outcome == 'success' else 'FAIL'
              secrets_text = 'PASS' if secrets_outcome == 'success' else 'FAIL'
              static_text = 'PASS' if static_outcome == 'success' else 'FAIL'
              jira_text = 'PASS' if jira_outcome == 'success' else 'FAIL'
              ai_text = 'PASS' if ai_outcome == 'success' else 'FAIL'
              
              # Determine if PR should be blocked
              blocking_issues = []
              if gitleaks_outcome != 'success':
                  blocking_issues.append('Secrets detected by Gitleaks')
              if secrets_outcome != 'success':
                  blocking_issues.append('Secrets detected by custom scanner')
              if static_outcome != 'success':
                  blocking_issues.append('Static analysis found blocking issues')
              if jira_outcome != 'success':
                  blocking_issues.append('Jira validation failed')
              
              summary = f'''## üìä PR Agent Review Summary
              
              {gitleaks_status} **Gitleaks Secret Scanning**: {gitleaks_text}
              {secrets_status} **Custom Secret Scanning**: {secrets_text}
              {static_status} **Static Code Analysis**: {static_text}
              {jira_status} **Jira Validation**: {jira_text}
              {ai_status} **AI Code Review**: {ai_text}
              '''
              
              if blocking_issues:
                  summary += f'''
              
              ## üö´ PR BLOCKED
              
              **This PR cannot be merged due to the following issues:**
              '''
                  for issue in blocking_issues:
                      summary += f'\n- ‚ùå {issue}'
                  summary += '\n\n**Please fix these issues before merging.**'
              else:
                  summary += '\n\n‚úÖ **All checks passed! This PR is ready to merge.**'
              
              summary += '\n\n---\n*This review was automatically generated by PR Agent*'
              
              github_api.post_comment(int(pr_number), summary)
              print('‚úÖ Summary comment posted')
          except Exception as e:
              print(f'‚ö†Ô∏è Error posting summary comment: {e}')
              import traceback
              traceback.print_exc()
              # Don't fail the workflow if comment posting fails
              sys.exit(0)
          "
